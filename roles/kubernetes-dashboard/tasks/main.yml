---

- name: Create Dashboard deployment
  community.kubernetes.k8s:
    src: dashboard-deployment.yml
    kubeconfig: "{{ playbook_dir }}/.kube-config"
    state: present

- name: Deploy Dashboard Service Account manifest
  community.kubernetes.k8s:
    src: service-account.yml
    kubeconfig: "{{ playbook_dir }}/.kube-config"
    state: present

- name: Deploy Dashboard Cluster Role binding manifest
  community.kubernetes.k8s:
    src: cluster-role-binding.yml
    kubeconfig: "{{ playbook_dir }}/.kube-config"
    state: present

- name: Expose Dashboard with Node Port Service
  community.kubernetes.k8s:
    src: service-node-port.yml
    kubeconfig: "{{ playbook_dir }}/.kube-config"
    state: present

- name: Get Port for Kubernetes Dashboard
  community.kubernetes.k8s_info:
    api_version: v1
    kind: Service
    name: kubernetes-dashboard
    namespace: kubernetes-dashboard
    field_selectors: metadata.spec
    kubeconfig: "{{ playbook_dir }}/.kube-config"
  register: dashboard_service

- name: Kubernetes Dashboard Port
  ansible.builtin.debug:
    msg: "Kubernetes Dashboard is available at Port: {{ dashboard_service.resources[0].spec.ports[0].nodePort }}"

- name: Obtain Bearer Token
  community.kubernetes.k8s_info:
    api_version: v1
    kind: Secret
    namespace: kubernetes-dashboard
    kubeconfig: "{{ playbook_dir }}/.kube-config"
  register: dashboard_token

- name: Output decoded Bearer Token
  debug: 
    msg: "{{ dashboard_token.resources[0].data.token | b64decode }}"